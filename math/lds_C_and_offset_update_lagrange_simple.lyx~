#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass article
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 1in
\topmargin 1in
\rightmargin 1in
\bottommargin 1in
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Part*
Expectation maximization of a linear dynamical system with a separate offset
 for each data set and an emissions matrix with columns that sum to 
\begin_inset Formula $1$
\end_inset


\end_layout

\begin_layout Standard
LDS equation with data sets indexed with 
\begin_inset Formula $i$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $x_{t}^{(i)}=Ax_{t}^{(i)}+Bu_{t}^{(i)}+w_{t}^{(i)}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $y_{t}^{(i)}=Cx_{t}^{(i)}+Du_{t}^{(i)}+d^{(i)}+v_{t}^{(i)}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $w_{t}^{(i)}\sim\mathcal{N}(0,Q)$
\end_inset

, 
\begin_inset Formula $v_{t}^{(i)}\sim\mathcal{N}(0,R)$
\end_inset


\end_layout

\begin_layout Standard
Consider the term of the complete data log likelihood 
\begin_inset Formula $L_{y}$
\end_inset

 which deals with emissions 
\begin_inset Formula $y$
\end_inset

 with 
\begin_inset Formula $T$
\end_inset

 time points and 
\begin_inset Formula $W$
\end_inset

 worms (data sets).
 All vectors are assumed to be column vectors
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L_{y}=\mathbb{E}\left[\sum_{t=1}^{T}\log\mathcal{N}(y_{t};Cx_{t},R)\right]=\begin{array}{c}
-\frac{1}{2}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[(y_{t}^{(i)}-Cx_{t}^{(i)}-Du_{t}^{(i)}-d^{(i)})^{\intercal}R^{-1}(y_{t}^{(i)}-Cx_{t}^{(i)}-Du_{t}^{(i)}-d^{(i)})\right]\\
-\frac{1}{2}\sum_{i=1}^{W}T^{(i)}\log|2\pi R|
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L_{y}=-\frac{1}{2}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[\begin{array}{c}
y_{t}^{(i)\intercal}R^{-1}y_{t}^{(i)}\\
-y_{t}^{(i)\intercal}R^{-1}Cx_{t}^{(i)}-x^{(i)\intercal}C^{\intercal}R^{-1}y_{t}^{(i)}\\
-y_{t}^{(i)\intercal}R^{-1}Du_{t}^{(i)}-u_{t}^{(i)\intercal}D^{\intercal}R^{-1}y_{t}^{(i)}\\
-y_{t}^{(i)\intercal}R^{-1}d^{(i)}-d^{(i)\intercal}R^{-1}y_{t}^{(i)}\\
+x_{t}^{(i)\intercal}C^{\intercal}R^{-1}Cx_{t}^{(i)}\\
+x_{t}^{(i)\intercal}C^{\intercal}R^{-1}Du_{t}^{(i)}+u_{t}^{(i)\intercal}D^{\intercal}R^{-1}Cx_{t}^{(i)}\\
+x_{t}^{(i)\intercal}C^{\intercal}R^{-1}d^{(i)}+d^{(i)\intercal}R^{-1}Cx_{t}^{(i)}\\
+u_{t}^{(i)\intercal}D^{\intercal}R^{-1}Du_{t}^{(i)}\\
+u_{t}^{(i)\intercal}D^{\intercal}R^{-1}d^{(i)}+d^{(i)\intercal}R^{-1}Du_{t}^{(i)}\\
+d^{(i)\intercal}R^{-1}d^{(i)}
\end{array}\right]-\frac{1}{2}\sum_{i=1}^{W}T^{(i)}\log|R|
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Because this entire term is a scalar, the entire thing can be written as
 a trace.
 Trace distributes across addition and matrix multiplication within a trace
 can be circularly permuted.
 Permute all the terms so that 
\begin_inset Formula $R^{-1}$
\end_inset

 is on the left
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L_{y}=-\frac{1}{2}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[\begin{array}{c}
\text{Tr}\left[R^{-1}y_{t}^{(i)}y_{t}^{(i)\intercal}\right]\\
-\text{Tr}\left[R^{-1}Cx_{t}^{(i)}y_{t}^{(i)\intercal}\right]-\text{Tr}\left[R^{-1}y_{t}^{(i)}x^{(i)\intercal}C^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}Du_{t}^{(i)}y_{t}^{(i)\intercal}\right]-\text{Tr}\left[R^{-1}y_{t}^{(i)}u_{t}^{(i)\intercal}D^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}d^{(i)}y_{t}^{(i)\intercal}\right]-\text{Tr}\left[R^{-1}y_{t}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}Cx_{t}^{(i)}x_{t}^{(i)\intercal}C^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}Du_{t}^{(i)}x_{t}^{(i)\intercal}C^{\intercal}\right]+\text{Tr}\left[R^{-1}Cx_{t}^{(i)}u_{t}^{(i)\intercal}D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}d^{(i)}x_{t}^{(i)\intercal}C^{\intercal}\right]+\text{Tr}\left[R^{-1}Cx_{t}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}Du_{t}^{(i)}u_{t}^{(i)\intercal}D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}d^{(i)}u_{t}^{(i)\intercal}D^{\intercal}\right]+\text{Tr}\left[R^{-1}Du_{t}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}d^{(i)}d^{(i)\intercal}\right]
\end{array}\right]-\frac{1}{2}\sum_{i=1}^{W}T^{(i)}\log|R|
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Distribute the expectation and the sums
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L_{y}=-\frac{1}{2}\left[\begin{array}{c}
\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)}y_{t}^{(i)\intercal}\right]\right]\\
-\text{Tr}\left[R^{-1}C\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)}y_{t}^{(i)\intercal}\right]\right]-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)}x^{(i)\intercal}\right]C^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}D\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}y_{t}^{(i)\intercal}\right]\right]-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)}u_{t}^{(i)\intercal}\right]D^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)\intercal}\right]\right]-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)}\right]d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}C\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)}x_{t}^{(i)\intercal}\right]C^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}D\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}x_{t}^{(i)\intercal}\right]C^{\intercal}\right]+\text{Tr}\left[R^{-1}C\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)}u_{t}^{(i)\intercal}\right]D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)\intercal}\right]C^{\intercal}\right]+\text{Tr}\left[R^{-1}C\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)}\right]d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}D\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}u_{t}^{(i)\intercal}\right]D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)\intercal}\right]D^{\intercal}\right]+\text{Tr}\left[R^{-1}D\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}\right]d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[d^{(i)}d^{(i)\intercal}\right]\right]
\end{array}\right]-\frac{1}{2}\sum_{i=1}^{W}T^{(i)}\log|R|
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
apply the expectation and calculate the following suff stats.
 Note that 
\begin_inset Formula $Y$
\end_inset

 and 
\begin_inset Formula $\tilde{Y}$
\end_inset

 get modified by imputing missing 
\begin_inset Formula $y$
\end_inset

 values, though no other stats are affected.
 I skip that here, but adjust in the code.
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{ccc}
Y=\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)}y_{t}^{(i)\intercal}\right] & \tilde{Y}=\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)}y_{t}^{(i)\intercal}\right] & \bar{Y}^{(i)}=\sum_{t=1}^{T}\mathbb{E}\left[y_{t}^{(i)\intercal}\right]\\
M_{(1,T)}=\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)}x_{t}^{(i)\intercal}\right] & U_{y}=\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}y_{t}^{(i)\intercal}\right] & \bar{M}^{(i)\intercal}=\sum_{t=1}^{T}\mathbb{E}\left[x_{t}^{(i)\intercal}\right]\\
U_{(1,T)}=\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}u_{t}^{(i)\intercal}\right] & \tilde{U}_{(1,T)}\sum_{i=1}^{W}\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)}x_{t}^{(i)\intercal}\right] & \bar{U}^{(i)}=\sum_{t=1}^{T}\mathbb{E}\left[u_{t}^{(i)\intercal}\right]
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L_{y}=-\frac{1}{2}\left[\begin{array}{c}
\text{Tr}\left[R^{-1}Y\right]\\
-\text{Tr}\left[R^{-1}C\tilde{Y}\right]-\text{Tr}\left[R^{-1}\tilde{Y}^{\intercal}C^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}DU_{y}\right]-\text{Tr}\left[R^{-1}U_{y}^{\intercal}D^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{Y}^{(i)\intercal}\right]-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\bar{Y}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}CM_{(1,T)}C^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}D\tilde{U}_{(1,T)}C^{\intercal}\right]+\text{Tr}\left[R^{-1}C\tilde{U}_{(1,T)}^{\intercal}D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{M}^{(i)\intercal}C^{\intercal}\right]+\text{Tr}\left[R^{-1}C\sum_{i=1}^{W}\bar{M}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}DU_{(1,T)}D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{U}^{(i)\intercal}D^{\intercal}\right]+\text{Tr}\left[R^{-1}D\sum_{i=1}^{W}\bar{U}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}T^{(i)}d^{(i)}d^{(i)\intercal}\right]
\end{array}\right]-\frac{1}{2}\sum_{i=1}^{W}T^{(i)}\log|R|
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Finally, add a lagrange multiplier such that the columns of 
\begin_inset Formula $C$
\end_inset

 sum to 
\begin_inset Formula $1$
\end_inset

: 
\begin_inset Formula $-\lambda^{\intercal}(1-C1)=-\lambda^{\intercal}1+\lambda^{\intercal}C1$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L_{y}=-\frac{1}{2}\left[\begin{array}{c}
\text{Tr}\left[R^{-1}Y\right]\\
-\text{Tr}\left[R^{-1}C\tilde{Y}\right]-\text{Tr}\left[R^{-1}\tilde{Y}^{\intercal}C^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}DU_{y}\right]-\text{Tr}\left[R^{-1}U_{y}^{\intercal}D^{\intercal}\right]\\
-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{Y}^{(i)\intercal}\right]-\text{Tr}\left[R^{-1}\sum_{i=1}^{W}\bar{Y}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}CM_{(1,T)}C^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}D\tilde{U}_{(1,T)}C^{\intercal}\right]+\text{Tr}\left[R^{-1}C\tilde{U}_{(1,T)}^{\intercal}D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{M}^{(i)\intercal}C^{\intercal}\right]+\text{Tr}\left[R^{-1}C\sum_{i=1}^{W}\bar{M}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}DU_{(1,T)}D^{\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{U}^{(i)\intercal}D^{\intercal}\right]+\text{Tr}\left[R^{-1}D\sum_{i=1}^{W}\bar{U}^{(i)}d^{(i)\intercal}\right]\\
+\text{Tr}\left[R^{-1}\sum_{i=1}^{W}T^{(i)}d^{(i)}d^{(i)\intercal}\right]
\end{array}\right]-\frac{1}{2}\sum_{i=1}^{W}T^{(i)}\log|R|-\lambda^{\intercal}1+\lambda^{\intercal}C1
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Take the derivative of 
\begin_inset Formula $L_{y}$
\end_inset

 with respect to 
\begin_inset Formula $C$
\end_inset

, 
\begin_inset Formula $\lambda$
\end_inset

, and 
\begin_inset Formula $d^{(i)}$
\end_inset

 using the trace derivative equations in the appendix.
 Treat 
\begin_inset Formula $D$
\end_inset

as a constant.
 Note that all the transposed terms end up with the same derivative.
 Don't forget the 
\begin_inset Formula $-\frac{1}{2}$
\end_inset

 in front
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{ccc}
\frac{\partial L_{y}}{\partial C} & = & R^{-1}\tilde{Y}^{\intercal}-R^{-1}CM_{(1,T)}-R^{-1}D\tilde{U}_{(1,T)}-R^{-1}\sum_{i=1}^{W}d^{(i)}\bar{M}^{(i)\intercal}+\lambda1^{\intercal}\\
\frac{\partial L_{y}}{\partial\lambda} & = & C1-1\\
\frac{\partial L_{y}}{\partial d^{(i)}} & = & R^{-1}\bar{Y}^{(i)}-R^{-1}C\bar{M}^{(i)}-R^{-1}D\bar{U}^{(i)}-T^{(i)}R^{-1}d^{(i)}
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Set all terms to 
\begin_inset Formula $0$
\end_inset

, multiply by 
\begin_inset Formula $R$
\end_inset

 and gather terms that don't include 
\begin_inset Formula $C$
\end_inset

, 
\begin_inset Formula $\lambda$
\end_inset

, or 
\begin_inset Formula $d^{(i)}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{ccc}
\tilde{Y}^{\intercal}-D\tilde{U}_{(1,T)} & = & CM_{(1,T)}+\sum_{i=1}^{W}d^{(i)}\bar{M}^{(i)\intercal}-R\lambda1^{\intercal}\\
1 & = & C1\\
\bar{Y}^{(i)}-D\bar{U}^{(i)} & = & C\bar{M}^{(i)}+T^{(i)}d^{(i)}
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Transpose and rewrite as a linear equation.
 Because 
\begin_inset Formula $R$
\end_inset

 is diagonal, all it does it change the amplitude of 
\begin_inset Formula $\lambda$
\end_inset

 which we don't use anywhere so we can safely remove the 
\begin_inset Formula $-R$
\end_inset

 term.
 I don't know about this notation, but there are as many entires for 
\begin_inset Formula $d^{(i)}$
\end_inset

 as there are data sets
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{ccc}
\tilde{Y}-\tilde{U}_{(1,T)}^{\intercal}D^{\intercal} & = & M_{(1,T)}C^{\intercal}+\bar{M}^{(i)}\sum_{i=1}^{W}d^{(i)\intercal}+1\lambda^{\intercal}(-R)\\
1^{\intercal} & = & 1^{\intercal}C^{\intercal}\\
\bar{Y}^{(i)\intercal}-\bar{U}^{(i)\intercal}D^{\intercal} & = & \bar{M}^{(i)\intercal}C^{\intercal}+\bar{U}^{(i)\intercal}D^{\intercal}+T^{(i)}d^{(i)\intercal}
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\begin{array}{c}
\tilde{Y}-\tilde{U}_{(1,T)}^{\intercal}D^{\intercal}\\
1^{\intercal}\\
\bar{Y}^{(i)\intercal}-\bar{U}^{(i)\intercal}D^{\intercal}
\end{array}\right]=\left[\begin{array}{ccc}
M_{(1,T)} & 1 & \bar{M}^{(i)}\\
1^{\intercal} & 0 & 0\\
\bar{M}^{(i)\intercal} & 0 & T^{(i)}
\end{array}\right]\left[\begin{array}{c}
C^{\intercal}\\
\lambda^{\intercal}\\
d^{(i)\intercal}
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Here is an example with two data sets
\end_layout

\begin_layout Standard
\begin_inset Formula $\left[\begin{array}{c}
\tilde{Y}-\tilde{U}_{(1,T)}^{\intercal}D^{\intercal}\\
1^{\intercal}\\
\bar{Y}^{(1)\intercal}-\bar{U}^{(1)\intercal}D^{\intercal}\\
\bar{Y}^{(2)\intercal}-\bar{U}^{(2)\intercal}D^{\intercal}
\end{array}\right]=\left[\begin{array}{cccc}
M_{(1,T)} & 1 & \bar{M}^{(1)} & \bar{M}^{(2)}\\
1^{\intercal} & 0 & 0 & 0\\
\bar{M}^{(1)\intercal} & 0 & T^{(1)} & 0\\
\bar{M}^{(2)\intercal} & 0 & 0 & T^{(2)}
\end{array}\right]\left[\begin{array}{c}
C^{\intercal}\\
\lambda^{\intercal}\\
d^{(1)\intercal}\\
d^{(2)\intercal}
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Subsection*
Solving for 
\begin_inset Formula $R$
\end_inset


\end_layout

\begin_layout Standard
Derivative rules are in the appendix
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial L_{y}}{\partial R^{-1}}=-\frac{1}{2}\left[\begin{array}{c}
Y\\
-C\tilde{Y}-\tilde{Y}^{\intercal}C^{\intercal}\\
-DU_{y}-U_{y}^{\intercal}D^{\intercal}\\
-\sum_{i=1}^{W}d^{(i)}\bar{Y}^{(i)\intercal}-\sum_{i=1}^{W}\bar{Y}^{(i)}d^{(i)\intercal}\\
+CM_{(1,T)}C^{\intercal}\\
+D\tilde{U}_{(1,T)}C^{\intercal}+C\tilde{U}_{(1,T)}^{\intercal}D^{\intercal}\\
+\sum_{i=1}^{W}d^{(i)}\bar{M}^{(i)\intercal}C^{\intercal}+C\sum_{i=1}^{W}\bar{M}^{(i)}d^{(i)\intercal}\\
+DU_{(1,T)}D^{\intercal}\\
+\sum_{i=1}^{W}d^{(i)}\bar{U}^{(i)\intercal}D^{\intercal}+D\sum_{i=1}^{W}\bar{U}^{(i)}d^{(i)\intercal}\\
+\sum_{i=1}^{W}T^{(i)}d^{(i)}d^{(i)\intercal}
\end{array}\right]+\frac{1}{2}\sum_{i=1}^{W}T^{(i)}R
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Set the derivative to 
\begin_inset Formula $0$
\end_inset

 and solve for 
\begin_inset Formula $R$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
R=\frac{1}{\sum_{i=1}^{W}T^{(i)}}\left[\begin{array}{c}
Y\\
-C\tilde{Y}-\tilde{Y}^{\intercal}C^{\intercal}\\
-DU_{y}-U_{y}^{\intercal}D^{\intercal}\\
-\sum_{i=1}^{W}d^{(i)}\bar{Y}^{(i)\intercal}-\sum_{i=1}^{W}\bar{Y}^{(i)}d^{(i)\intercal}\\
+CM_{(1,T)}C^{\intercal}\\
+D\tilde{U}_{(1,T)}C^{\intercal}+C\tilde{U}_{(1,T)}^{\intercal}D^{\intercal}\\
+\sum_{i=1}^{W}d^{(i)}\bar{M}^{(i)\intercal}C^{\intercal}+C\sum_{i=1}^{W}\bar{M}^{(i)}d^{(i)\intercal}\\
+DU_{(1,T)}D^{\intercal}\\
+\sum_{i=1}^{W}d^{(i)}\bar{U}^{(i)\intercal}D^{\intercal}+D\sum_{i=1}^{W}\bar{U}^{(i)}d^{(i)\intercal}\\
+\sum_{i=1}^{W}T^{(i)}d^{(i)}d^{(i)\intercal}
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection*
Appendix
\end_layout

\begin_layout Subparagraph*
Trace and determinant derivatives
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial}{\partial X}\text{Tr}\left[AXB\right]=A^{\intercal}B^{\intercal}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial}{\partial X}\text{Tr}\left[AX^{\intercal}B\right]=BA
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
If 
\begin_inset Formula $C$
\end_inset

 is the identity and 
\begin_inset Formula $A$
\end_inset

 and 
\begin_inset Formula $B$
\end_inset

 are symmetric
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial}{\partial X}\text{Tr}\left[A_{\text{sym}}XB_{\text{sym}}X^{\intercal}\right]=2AXB
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial}{\partial X^{-1}}\log|X|=-X
\end{equation}

\end_inset


\end_layout

\end_body
\end_document
