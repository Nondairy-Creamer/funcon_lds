#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass article
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Subparagraph*
Trace derivatives
\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial}{\partial X}\text{Tr}\left[AXB\right]=A^{\intercal}B^{\intercal}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial}{\partial X}\text{Tr}\left[AX^{\intercal}B\right]=BA$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial}{\partial X}\text{Tr}\left[X^{\intercal}AX\right]=(A+A^{\intercal})X$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial}{\partial X}\text{Tr}\left[AXBX^{\intercal}C\right]=\frac{\partial}{\partial X}\text{Tr}\left[AXD\right]+\frac{\partial}{\partial X}\text{Tr}\left[EX^{\intercal}C\right]=A^{\intercal}D^{\intercal}+EC$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $D=BX^{\intercal}C$
\end_inset

 and 
\begin_inset Formula $E=AXB$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial}{\partial X}\text{Tr}\left[AXBX^{\intercal}C\right]=A^{\intercal}C^{\intercal}XB^{\intercal}+AXBC$
\end_inset


\end_layout

\begin_layout Standard
If 
\begin_inset Formula $C$
\end_inset

 is the identity and 
\begin_inset Formula $A$
\end_inset

 and 
\begin_inset Formula $B$
\end_inset

 are symmetric
\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial}{\partial X}\text{Tr}\left[A_{\text{sym}}XB_{\text{sym}}X^{\intercal}\right]=2AXB$
\end_inset


\end_layout

\begin_layout Standard
Complete data log likelihood
\end_layout

\begin_layout Standard
\begin_inset Formula $\mathbb{E}\left[\sum_{t=1}^{T}\log\mathcal{N}(y_{t};Cx_{t},R)\right]=-\frac{1}{2}\mathbb{E}\left[\sum_{t=1}^{T}(y_{t}-Cx_{t}-Du_{t}-d)^{\intercal}R^{-1}(y_{t}-Cx_{t}-Du_{t}-d)\right]-\frac{T}{2}\log|2\pi R|$
\end_inset


\end_layout

\begin_layout Standard
To save space on terms, I group the cross terms like 
\begin_inset Formula $x_{t}y_{t}^{\intercal}$
\end_inset

 with 
\begin_inset Formula $y_{t}x_{t}^{\intercal}$
\end_inset

.
 They aren't symmetric, but they have the same derivative so it ends up
 not mattering except when calculating the derivative of 
\begin_inset Formula $R^{-1}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $=-\frac{1}{2}\text{Tr}\left[R^{-1}\sum_{t=1}^{T}y_{t}y_{t}^{\intercal}-2R^{-1}C\sum_{t=1}^{T}\mathbb{E}[x_{t}y_{t}^{\intercal}]-2R^{-1}D\sum_{t=1}^{T}u_{t}y_{t}^{\intercal}-2R^{-1}\sum_{t=1}^{T}y_{t}d^{\intercal}+C^{\intercal}R^{-1}C\sum_{t=1}^{T}\mathbb{E}[x_{t}x_{t}^{\intercal}]+2R^{-1}C\sum_{t=1}^{T}\mathbb{E}[x_{t}u_{t}^{\intercal}]D^{\intercal}+2R^{-1}C\sum_{t=1}^{T}\mathbb{E}[x_{t}d^{\intercal}]+D^{\intercal}R^{-1}D\sum_{t=1}^{T}u_{t}u_{t}^{\intercal}+2R^{-1}D\sum_{t=1}^{T}u_{t}d^{\intercal}+R^{-1}Tdd^{\intercal}\right]-\frac{T}{2}\log|2\pi R|-\lambda^{\intercal}(1-C1)$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $=-\frac{1}{2}\text{Tr}\left[R^{-1}\sum_{t=1}^{T}y_{t}y_{t}^{\intercal}-2R^{-1}C\sum_{t=1}^{T}m_{t}y_{t}^{\intercal}-2R^{-1}D\sum_{t=1}^{T}u_{t}y_{t}^{\intercal}-2R^{-1}\sum_{t=1}^{T}y_{t}d^{\intercal}+C^{\intercal}R^{-1}C\sum_{t=1}^{T}m_{t}m_{t}^{\intercal}+2R^{-1}C\sum_{t=1}^{T}m_{t}u_{t}^{\intercal}D^{\intercal}+2R^{-1}C\sum_{t=1}^{T}m_{t}d^{\intercal}+D^{\intercal}R^{-1}D\sum_{t=1}^{T}u_{t}u_{t}^{\intercal}+2R^{-1}D\sum_{t=1}^{T}u_{t}d^{\intercal}+R^{-1}Tdd^{\intercal}\right]-\frac{T}{2}\log|2\pi R|-\lambda^{\intercal}(1-C1)$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $=-\frac{1}{2}\text{Tr}\left[R^{-1}\sum_{t=1}^{T}y_{t}y_{t}^{\intercal}\right]+\text{Tr}\left[R^{-1}C\sum_{t=1}^{T}m_{t}y_{t}^{\intercal}\right]+\text{Tr}\left[R^{-1}D\sum_{t=1}^{T}u_{t}y_{t}^{\intercal}\right]+\text{Tr}\left[R^{-1}\sum_{t=1}^{T}y_{t}d^{\intercal}\right]-\frac{1}{2}\text{Tr}\left[C^{\intercal}R^{-1}C\sum_{t=1}^{T}m_{t}m_{t}^{\intercal}\right]-\text{Tr}\left[R^{-1}C\sum_{t=1}^{T}m_{t}u_{t}^{\intercal}D^{\intercal}\right]-\text{Tr}\left[R^{-1}C\sum_{t=1}^{T}m_{t}d^{\intercal}\right]-\frac{1}{2}\text{Tr}\left[D^{\intercal}R^{-1}D\sum_{t=1}^{T}u_{t}u_{t}^{\intercal}\right]-\text{Tr}\left[R^{-1}D\sum_{t=1}^{T}u_{t}d^{\intercal}\right]-\frac{T}{2}\text{Tr}\left[R^{-1}dd^{\intercal}\right]-\frac{T}{2}\log|2\pi R|-\lambda^{\intercal}(1-C1)$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $=-\frac{1}{2}\text{Tr}\left[R^{-1}Y\right]+\text{Tr}\left[R^{-1}C\tilde{Y}\right]+\text{Tr}\left[R^{-1}DU_{y}\right]+\text{Tr}\left[R^{-1}\sum_{t=1}^{T}y_{t}d^{\intercal}\right]-\frac{1}{2}\text{Tr}\left[C^{\intercal}R^{-1}CM_{(1,T)}\right]-\text{Tr}\left[R^{-1}C\tilde{U}_{(1,T)}D^{\intercal}\right]-\text{Tr}\left[R^{-1}C\sum_{t=1}^{T}m_{t}d^{\intercal}\right]-\frac{1}{2}\text{Tr}\left[D^{\intercal}R^{-1}D\sum_{t=1}^{T}U_{(1,T)}\right]-\text{Tr}\left[R^{-1}D\sum_{t=1}^{T}u_{t}d^{\intercal}\right]-\frac{T}{2}\text{Tr}\left[R^{-1}dd^{\intercal}\right]-\frac{T}{2}\log|2\pi R|-\lambda^{\intercal}1+\lambda^{\intercal}C1$
\end_inset


\end_layout

\begin_layout Standard
Derivative with respect to 
\begin_inset Formula $d$
\end_inset

, and sneakily add in the sums over 
\begin_inset Formula $W$
\end_inset

 worms
\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial L_{CD}}{\partial C}=R^{-1}\sum_{i}^{W}\tilde{Y}^{(i)\intercal}-R^{-1}C\sum_{i}^{W}M_{(1,T)}^{(i)}-R^{-1}D\tilde{U}_{(1,T)}^{\intercal}-R^{-1}\sum_{i}^{W}d^{(i)}\sum_{t=1}^{T}m_{t}^{(i)\intercal}-W\lambda1^{\intercal}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial L_{CD}}{\partial\lambda}=WC1-W1$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\frac{\partial L_{CD}}{\partial d_{i}}=R^{-1}\sum_{t=1}^{T^{(i)}}y_{t}^{(i)}-R^{-1}C\sum_{t=1}^{T^{(i)}}m_{t}^{(i)}-R^{-1}D\sum_{t=1}^{T^{(i)}}u_{t}^{(i)}-R^{-1}T^{(i)}d^{(i)}$
\end_inset


\end_layout

\begin_layout Standard
set all terms to 0
\end_layout

\begin_layout Standard
\begin_inset Formula $0=\sum_{i}^{W}\tilde{Y}^{(i)\intercal}-C\sum_{i}^{W}M_{(1,T)}^{(i)}-D\tilde{U}_{(1,T)}^{\intercal}-\sum_{i}^{W}d^{(i)}\sum_{t=1}^{T^{(i)}}m_{t}^{(i)\intercal}-W\lambda1^{\intercal}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $0=C1-1$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $0=\sum_{t=1}^{T^{(i)}}y_{t}^{(i)}-C\sum_{t=1}^{T^{(i)}}m_{t}^{(i)}-D\sum_{t=1}^{T^{(i)}}u_{t}^{(i)}-T^{(i)}d^{(i)}$
\end_inset


\end_layout

\begin_layout Standard
gather all terms not including 
\begin_inset Formula $d$
\end_inset

, 
\begin_inset Formula $C$
\end_inset

, or 
\begin_inset Formula $\lambda$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\sum_{i}^{W}\tilde{Y}^{(i)\intercal}-D\tilde{U}_{(1,T)}^{\intercal}=C\sum_{i}^{W}M_{(1,T)}^{(i)}+\sum_{i}^{W}d^{(i)}\sum_{t=1}^{T^{(i)}}m_{t}^{(i)\intercal}+W\lambda1^{\intercal}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $1=C1$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\sum_{t=1}^{T^{(i)}}y_{t}^{(i)}-D\sum_{t=1}^{T^{(i)}}u_{t}^{(i)}=C\sum_{t=1}^{T^{(i)}}m_{t}^{(i)}+T^{(i)}d^{(i)}$
\end_inset


\end_layout

\begin_layout Standard
Turn it into a linear equation
\end_layout

\begin_layout Standard
\begin_inset Formula $\left[\begin{array}{ccc}
\sum_{i}^{W}\tilde{Y}^{(i)\intercal}-D\tilde{U}_{(1,T)}^{\intercal} & 1 & \sum_{t=1}^{T^{(i)}}y_{t}^{(i)}-D\sum_{t=1}^{T^{(i)}}u_{t}^{(i)}\end{array}\right]=\left[\begin{array}{ccc}
C & \lambda & d^{(i)}\end{array}\right]\left[\begin{array}{ccc}
\sum_{i}^{W}M_{(1,T)}^{(i)} & 1 & \sum_{t=1}^{T^{(i)}}m_{t}^{(i)}\\
W1^{\intercal} & 0 & 0\\
\sum_{t=1}^{T}m_{t}^{(i)\intercal} & 0 & T^{(i)}
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\left[\begin{array}{c}
\sum_{i}^{W}\tilde{Y}^{(i)}-\tilde{U}_{(1,T)}D^{\intercal}\\
1^{\intercal}\\
\sum_{t=1}^{T^{(i)}}y_{t}^{(i)\intercal}-\sum_{t=1}^{T^{(i)}}u_{t}^{(i)\intercal}D^{\intercal}
\end{array}\right]=\left[\begin{array}{ccc}
\sum_{i}^{W}M_{(1,T)}^{(i)} & W1 & \sum_{t=1}^{T}m_{t}^{(i)}\\
1^{\intercal} & 0 & 0\\
\sum_{t=1}^{T^{(i)}}m_{t}^{(i)\intercal} & 0 & T^{(i)}
\end{array}\right]\left[\begin{array}{c}
C^{\intercal}\\
\lambda^{\intercal}\\
d^{(i)\intercal}
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Standard
Write this out for two data sets
\end_layout

\begin_layout Standard
\begin_inset Formula $\left[\begin{array}{c}
\sum_{i}^{W}\tilde{Y}^{(i)}-\tilde{U}_{(1,T)}D^{\intercal}\\
1^{\intercal}\\
\sum_{t=1}^{T^{(1)}}y_{t}^{(1)\intercal}-\sum_{t=1}^{T^{(1)}}u_{t}^{(1)\intercal}D^{\intercal}\\
\sum_{t=1}^{T^{(2)}}y_{t}^{(2)\intercal}-\sum_{t=1}^{T^{(2)}}u_{t}^{(2)\intercal}D^{\intercal}
\end{array}\right]=\left[\begin{array}{cccc}
\sum_{i}^{W}M_{(1,T)}^{(i)} & W1 & \sum_{t=1}^{T}m_{t}^{(1)} & \sum_{t=1}^{T}m_{t}^{(2)}\\
1^{\intercal} & 0 & 0 & 0\\
\sum_{t=1}^{T^{(1)}}m_{t}^{(1)\intercal} & 0 & T^{(1)} & 0\\
\sum_{t=1}^{T^{(2)}}m_{t}^{(2)\intercal} & 0 & 0 & T^{(2)}
\end{array}\right]\left[\begin{array}{c}
C^{\intercal}\\
\lambda^{\intercal}\\
d^{(1)\intercal}\\
d^{(2)\intercal}
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Standard
Use lemma for block matrix inversions to simplify
\end_layout

\begin_layout Standard
\begin_inset Formula $\alpha=\left[\begin{array}{cc}
\sum_{i}^{W}M_{(1,T)}^{(i)} & W1\\
1^{\intercal} & 0
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\beta=\left[\begin{array}{cc}
\sum_{t=1}^{T}m_{t}^{(1)} & \sum_{t=1}^{T}m_{t}^{(2)}\\
0 & 0
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\gamma=\beta^{\intercal}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\delta=\left[\begin{array}{cc}
T^{(1)} & 0\\
0 & T^{(2)}
\end{array}\right]$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $F=\alpha-\beta\delta^{-1}\gamma$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $\left[\begin{array}{cc}
\alpha & \beta\\
\gamma & \delta
\end{array}\right]^{-1}=\left[\begin{array}{cc}
F^{-1} & -F^{-1}\beta\delta^{-1}\\
-\delta^{-1}\gamma F^{-1} & \delta^{-1}+\delta^{-1}\gamma F^{-1}\beta\delta^{-1}
\end{array}\right]$
\end_inset


\end_layout

\end_body
\end_document
